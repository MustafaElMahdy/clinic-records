{% extends "base.html" %}
{% block title %}{{ patient.full_name }}{% endblock %}
{% block content %}

<div class="row" style="align-items:center; justify-content:space-between;">
  <div>
    <h1>{{ patient.full_name }}</h1>
    <div class="muted">
      {{ patient.phone }} {% if patient.national_id %} ‚Ä¢ {{ patient.national_id }}{% endif %}
    </div>
  </div>
  <div style="display: flex; gap: 8px;">
    {% if user.role == "doctor" or user.role == "admin" %}
      <a class="btn" href="{% url 'patients:edit' patient.pk %}">Edit Patient</a>
    {% endif %}
    <a class="btn" href="{% url 'patients:list' %}">‚Üê Back</a>
  </div>
</div>

<div class="split" style="margin-top:14px;">
  <div class="card">
    {% if can_add_visit %}
    <h2>Add Visit</h2>
    <form method="post">
    {% csrf_token %}
    {{ visit_form.as_p }}
    <button class="btn primary" type="submit">Add Visit</button>
    </form>
    {% else %}
        <p class="muted">You don‚Äôt have permission to add visits.</p>
    {% endif %}
  </div>

  <div class="card">
    <h2>Patient Info</h2>
    <p><b>Sex:</b> {{ patient.sex }}</p>
    <p><b>DOB:</b> {{ patient.date_of_birth }}</p>
    <p><b>Address:</b> {{ patient.address }}</p>
    {% if patient.notes %}<p><b>Notes:</b><br>{{ patient.notes|linebreaksbr }}</p>{% endif %}
  </div>
</div>

<div class="card" style="margin-top:14px;">
  <h2>Visit History</h2>
  {% for v in visits %}
  <div class="card visit-row">

    <div class="visit-left">
      <div class="muted">
        <b>{{ v.visit_datetime }}</b>
        {% if v.doctor %} ‚Ä¢ Dr. {{ v.doctor.username }}{% endif %}
        {% if v.follow_up_date %} ‚Ä¢ Follow-up: {{ v.follow_up_date }}{% endif %}
      </div>

      {% if v.chief_complaint %}<div><b>Complaint:</b> {{ v.chief_complaint }}</div>{% endif %}
      {% if v.diagnosis %}<div><b>Diagnosis:</b> {{ v.diagnosis }}</div>{% endif %}

      <div style="margin-top:6px;"><b>Notes:</b><br>{{ v.clinical_notes|linebreaksbr }}</div>
      {% if v.treatment_plan %}<div style="margin-top:6px;"><b>Plan:</b><br>{{ v.treatment_plan|linebreaksbr }}</div>{% endif %}
    </div>

    {% if user.role == "doctor" or user.role == "admin" %}
      <div class="visit-right">
        <a href="{% url 'visits:edit' v.pk %}" class="btn">Edit</a>
      </div>
    {% endif %}

  </div>
{% endfor %}
</div>

<div class="card" style="margin-top:14px;">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <h2 style="margin: 0;">Medical Documents & Files</h2>
    <a href="{% url 'files:upload' patient.pk %}" class="btn primary">Upload File</a>
  </div>

  {% if attachments %}
    <div class="file-grid">
      {% for attachment in attachments %}
        <div class="file-card">
          <div class="file-preview">
            {% if attachment.is_image %}
              <a href="{% url 'files:download' attachment.pk %}" target="_blank">
                <img src="{% url 'files:download' attachment.pk %}" alt="{{ attachment.original_filename }}" style="max-width: 100%; max-height: 150px; object-fit: cover;">
              </a>
            {% elif attachment.is_pdf %}
              <a href="{% url 'files:download' attachment.pk %}" target="_blank">
                <div class="file-icon pdf">üìÑ PDF</div>
              </a>
            {% else %}
              <a href="{% url 'files:download' attachment.pk %}">
                <div class="file-icon doc">üìé DOC</div>
              </a>
            {% endif %}
          </div>

          <div class="file-info">
            <div class="file-name" title="{{ attachment.original_filename }}">
              {{ attachment.original_filename|truncatechars:30 }}
            </div>
            <div class="file-meta muted">
              <span class="badge">{{ attachment.get_file_type_display }}</span>
              {{ attachment.get_file_size_display }} ‚Ä¢ {{ attachment.uploaded_at|date:"Y-m-d" }}
            </div>
            {% if attachment.title %}
              <div class="file-title" style="margin-top: 4px; font-size: 0.9em;">
                {{ attachment.title }}
              </div>
            {% endif %}
            {% if attachment.visit %}
              <div class="muted" style="font-size: 0.85em; margin-top: 4px;">
                Linked to visit: {{ attachment.visit.visit_datetime|date:"Y-m-d" }}
              </div>
            {% endif %}
          </div>

          <div class="file-actions">
            <a href="{% url 'files:download' attachment.pk %}" class="btn">View/Download</a>
            {% if user.role == "doctor" or user.role == "admin" %}
              <a href="{% url 'files:delete' attachment.pk %}" class="btn danger">Delete</a>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="muted">No files uploaded yet.</p>
  {% endif %}
</div>

{% if can_view_audit %}
  <div class="card" style="margin-top:14px;">
    <h2>Audit</h2>
    <div class="muted" style="margin-bottom:10px;">
      Recent activity for this patient (views, visit creation/edits).
    </div>

    {% if audit_events %}
      <table class="table">
        <tr>
          <th>Time</th>
          <th>Action</th>
          <th>By</th>
          <th>Details</th>
        </tr>
        {% for e in audit_events %}
          <tr>
            <td class="muted">{{ e.created_at }}</td>
            <td><span class="badge">{{ e.action }}</span></td>
            <td>
              {% if e.actor %}
                {{ e.actor.username }}
              {% else %}
                <span class="muted">System</span>
              {% endif %}
            </td>
            <td class="muted">
              {% if e.action == "patient_viewed" %}
                Viewed patient record

              {% elif e.action == "visit_created" %}
                Visit created
                {% if e.visit_id %}
                  ‚Ä¢ <a href="{% url 'visits:edit' e.visit_id %}">open</a>
                {% endif %}

              {% elif e.action == "visit_edited" %}
                Visit edited
                {% if e.visit_id %}
                  ‚Ä¢ <a href="{% url 'visits:edit' e.visit_id %}">open</a>
                {% endif %}

              {% elif e.action == "patient_created" %}
                Patient created

              {% elif e.action == "patient_edited" %}
                Patient details edited

              {% elif e.action == "file_uploaded" %}
                Uploaded: <strong>{{ e.metadata.filename }}</strong>
                <span class="badge">{{ e.metadata.file_type }}</span>
                ({{ e.metadata.file_size|filesizeformat }})

              {% elif e.action == "file_downloaded" %}
                Downloaded: <strong>{{ e.metadata.filename }}</strong>

              {% elif e.action == "file_deleted" %}
                Deleted: <strong>{{ e.metadata.filename }}</strong>
                <span class="badge">{{ e.metadata.file_type }}</span>

              {% else %}
                ‚Äî
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </table>
    {% else %}
      <p class="muted">No audit events yet.</p>
    {% endif %}
  </div>
{% endif %}

{% endblock %}
